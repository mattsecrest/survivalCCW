<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How to Conduct a Clone Censor-Weight Survival Analysis using survivalCCW • survivalCCW</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How to Conduct a Clone Censor-Weight Survival Analysis using survivalCCW">
<meta property="og:description" content="survivalCCW">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">survivalCCW</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/conduct-ccw-analysis.html">How to Conduct a Clone Censor-Weight Survival Analysis using survivalCCW</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How to Conduct a Clone Censor-Weight Survival
Analysis using survivalCCW</h1>
                        <h4 data-toc-skip class="author">Matthew
Secrest</h4>
            
      
      
      <div class="hidden name"><code>conduct-ccw-analysis.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="clone-censor-weighting">Clone Censor Weighting<a class="anchor" aria-label="anchor" href="#clone-censor-weighting"></a>
</h2>
<p>This lightweight package describes how to conduct clone-censor
weighting (CCW) to address the problem of immortal time bias in survival
analysis. This vignette will walk through the applied tutorial published
by <a href="https://academic.oup.com/ije/article/49/5/1719/5835351" class="external-link">Maringe et
al 2020</a>. Refer to <a href="https://doi.org/10.1093/aje/kwv254" class="external-link">Hernan and Robins 2016</a> and
<a href="https://doi.org/10.1016/j.jclinepi.2016.04.014" class="external-link">Hernan et al
2016</a> for more technical details.</p>
</div>
<div class="section level2">
<h2 id="context">Context<a class="anchor" aria-label="anchor" href="#context"></a>
</h2>
<p>CCW is useful in the presence of immortal person-time bias in
observational studies. For instance, when comparing surgery recipients
vs non-recipients in non-small cell lung cancer (NSCLC), the surgery
group will have a longer survival time than the non-surgery group
because the non-surgery group includes patients who died before they
could receive surgery. This is a form of immortal time bias.</p>
<p>The CCW toy dataset published by Maringe uses this exact setting as
the motivating example. Let’s explore the dataset, which comes with
<code>survivalCCW</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">survivalCCW</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">toy_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;      id surgery timetosurgery death sex charlson perf stage emergency fup_obs</span></span>
<span><span class="co">#&gt; 1 P5958       0            NA     0   2        1    2     2         1  365.24</span></span>
<span><span class="co">#&gt; 2 P3075       0            NA     0   2        1    0     2         0  365.24</span></span>
<span><span class="co">#&gt; 3 P1410       0            NA     0   1        1    2     1         0  365.24</span></span>
<span><span class="co">#&gt; 4 P4957       0            NA     0   2        0    1     1         0  365.24</span></span>
<span><span class="co">#&gt; 5 P7340       0            NA     1   1        0    2     2         1  123.00</span></span>
<span><span class="co">#&gt; 6 P1917       0            NA     0   2        0    0     1         0  365.24</span></span>
<span><span class="co">#&gt;        age deprivation</span></span>
<span><span class="co">#&gt; 1 79.57290        0.42</span></span>
<span><span class="co">#&gt; 2 82.91855        0.07</span></span>
<span><span class="co">#&gt; 3 84.03011        0.22</span></span>
<span><span class="co">#&gt; 4 78.34634        0.12</span></span>
<span><span class="co">#&gt; 5 83.63860        0.40</span></span>
<span><span class="co">#&gt; 6 82.26147        0.03</span></span></code></pre></div>
<p>Column descriptions can be found with <code><a href="../reference/toy_df.html">?toy_df</a></code>:</p>
<ul>
<li>
<code>id</code>: patient identifier</li>
<li>
<code>fup_obs</code>: observed follow-up time (time to death or 1
year if censored alive)</li>
<li>
<code>death</code>: observed event of interest (all-cause death) 1:
dead, 0: alive</li>
<li>
<code>timetosurgery</code>: time to surgery (NA if no surgery)</li>
<li>
<code>age</code>: age at diagnosis</li>
<li>
<code>sex</code>: patient’s sex</li>
<li>
<code>perf</code>: performance status at diagnosis</li>
<li>
<code>stage</code>: stage at diagnosis</li>
<li>
<code>deprivation</code>: deprivation score</li>
<li>
<code>charlson</code>: Charlson’s comorbidity index</li>
<li>
<code>emergency</code>: route to diagnosis</li>
</ul>
<p>Note that this package addresses situations in which the covariates
are all defined at baseline.</p>
</div>
<div class="section level2">
<h2 id="create-clones">Create clones<a class="anchor" aria-label="anchor" href="#create-clones"></a>
</h2>
<p>The first step is to create the clones. This can be done for any
time-to-event outcome using the <code>survivalCCW</code> function
<code>create_clones</code>. For <code>create_clones</code> to work, we
need to pass a one-row-per-patient <code>data.frame</code> with the
following columns:</p>
<ul>
<li>The id variable (in this case, <code>id</code>)</li>
<li>The traditional outcome variable which denotes censorship (0) or
event (1) (in this case, <code>death</code>). Note that additional
values are not yet permitted.</li>
<li>The time to the first event (in this case,
<code>fup_obs</code>)</li>
<li>The exposure variable, with exposure defined <strong>at any time
prior to censorship/event</strong> (in this case, <code>surgery</code>).
Must be (0) or (1),</li>
<li>The time to exposure variable (in this case,
<code>timetosurgery</code>)</li>
<li>The clinical eligibility window (in this case, we’ll do 6
months)</li>
</ul>
<p>All other columns will be propogated for each patient. Let’s see what
this looks like in practice.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="co"># Create clones</span></span>
<span><span class="va">clones</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_clones.html">create_clones</a></span><span class="op">(</span></span>
<span>  df <span class="op">=</span> <span class="va">toy_df</span>,</span>
<span>  id <span class="op">=</span> <span class="st">'id'</span>,</span>
<span>  event <span class="op">=</span> <span class="st">'death'</span>,</span>
<span>  time_to_event <span class="op">=</span> <span class="st">'fup_obs'</span>,</span>
<span>  exposure <span class="op">=</span> <span class="st">'surgery'</span>,</span>
<span>  time_to_exposure <span class="op">=</span> <span class="st">'timetosurgery'</span>,</span>
<span>  ced_window <span class="op">=</span> <span class="fl">182.62</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">clones</span><span class="op">)</span></span>
<span><span class="co">#&gt;      id surgery timetosurgery death sex charlson perf stage emergency fup_obs</span></span>
<span><span class="co">#&gt; 1 P1074       0            NA     1   2        1    2     1         0  345.00</span></span>
<span><span class="co">#&gt; 2 P1074       0            NA     1   2        1    2     1         0  345.00</span></span>
<span><span class="co">#&gt; 3 P1186       1           112     0   2        0    1     1         0  365.24</span></span>
<span><span class="co">#&gt; 4 P1186       1           112     0   2        0    1     1         0  365.24</span></span>
<span><span class="co">#&gt; 5 P1189       1            41     1   1        1    1     1         0  226.00</span></span>
<span><span class="co">#&gt; 6 P1189       1            41     1   1        1    1     1         0  226.00</span></span>
<span><span class="co">#&gt;        age deprivation outcome fup_outcome censor fup_censor clone</span></span>
<span><span class="co">#&gt; 1 76.67899        0.33       1      345.00      0     182.62     0</span></span>
<span><span class="co">#&gt; 2 76.67899        0.33       0      182.62      1     182.62     1</span></span>
<span><span class="co">#&gt; 3 78.73512        0.04       0      112.00      1     112.00     0</span></span>
<span><span class="co">#&gt; 4 78.73512        0.04       0      365.24      0     112.00     1</span></span>
<span><span class="co">#&gt; 5 75.92608        0.04       0       41.00      1      41.00     0</span></span>
<span><span class="co">#&gt; 6 75.92608        0.04       1      226.00      0      41.00     1</span></span></code></pre></div>
<p>Note that this object is just a <code>data.frame</code> with an
additional custom class which future functions will evaluate:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">clones</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "ccw_clones" "data.frame"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="cast-to-long-format">Cast to long format<a class="anchor" aria-label="anchor" href="#cast-to-long-format"></a>
</h2>
<p>Now we simply need to cast the data to long format. The
<code>survivalCCW</code> function <code>cast_to_long</code> will do this
for us. No additional arguments are needed (the <code>clones</code>
object is an artifact that allows you to better see and understand the
method):</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clones_long</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cast_clones_to_long.html">cast_clones_to_long</a></span><span class="op">(</span><span class="va">clones</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">clones_long</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;   time_id t_start    id surgery timetosurgery death sex charlson perf stage</span></span>
<span><span class="co">#&gt; 1       0       0 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt; 2       1       1 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt; 3       2       7 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt; 4       3       8 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt; 5       4      10 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt; 6       5      16 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt;   emergency fup_obs      age deprivation censor fup_censor clone fup_outcome</span></span>
<span><span class="co">#&gt; 1         0     345 76.67899        0.33      0     182.62     0           1</span></span>
<span><span class="co">#&gt; 2         0     345 76.67899        0.33      0     182.62     0           7</span></span>
<span><span class="co">#&gt; 3         0     345 76.67899        0.33      0     182.62     0           8</span></span>
<span><span class="co">#&gt; 4         0     345 76.67899        0.33      0     182.62     0          10</span></span>
<span><span class="co">#&gt; 5         0     345 76.67899        0.33      0     182.62     0          16</span></span>
<span><span class="co">#&gt; 6         0     345 76.67899        0.33      0     182.62     0          18</span></span>
<span><span class="co">#&gt;   outcome t_stop t_event</span></span>
<span><span class="co">#&gt; 1       0      1      NA</span></span>
<span><span class="co">#&gt; 2       0      7       1</span></span>
<span><span class="co">#&gt; 3       0      8       7</span></span>
<span><span class="co">#&gt; 4       0     10       8</span></span>
<span><span class="co">#&gt; 5       0     16      10</span></span>
<span><span class="co">#&gt; 6       0     18      16</span></span></code></pre></div>
<p>Let’s pick out a single patient and look at their data:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">clones_long</span><span class="op">[</span><span class="va">clones_long</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="st">"P5913"</span>, <span class="op">]</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  time_id t_start    id surgery timetosurgery death sex charlson perf stage</span></span>
<span><span class="co">#&gt;        0       0 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        0       0 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        1       1 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        2       7 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        3       8 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        4      10 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        5      16 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        6      18 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        7      19 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        8      20 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        9      22 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       10      23 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       11      25 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       12      26 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       13      27 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       14      28 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       15      29 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       16      30 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       17      33 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       18      34 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       19      36 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       20      37 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       21      38 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       22      39 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       23      40 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       24      41 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       25      42 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       26      43 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       27      45 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       28      46 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       29      48 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       30      50 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       31      51 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       32      57 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       33      58 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       34      60 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       35      67 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       36      76 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       37      79 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       38      83 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       39      84 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       40      88 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       41      89 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       42      90 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       43      95 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       44      97 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       45     102 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       46     104 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       47     106 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;  emergency fup_obs      age deprivation censor fup_censor clone fup_outcome</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      1          1     0           1</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1           1</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1           7</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1           8</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          10</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          16</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          18</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          19</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          20</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          22</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          23</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          25</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          26</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          27</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          28</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          29</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          30</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          33</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          34</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          36</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          37</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          38</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          39</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          40</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          41</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          42</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          43</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          45</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          46</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          48</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          50</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          51</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          57</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          58</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          60</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          67</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          76</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          79</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          83</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          84</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          88</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          89</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          90</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          95</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          97</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1         102</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1         104</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1         106</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1         109</span></span>
<span><span class="co">#&gt;  outcome t_stop t_event</span></span>
<span><span class="co">#&gt;        0      1      NA</span></span>
<span><span class="co">#&gt;        0      1      NA</span></span>
<span><span class="co">#&gt;        0      7       1</span></span>
<span><span class="co">#&gt;        0      8       7</span></span>
<span><span class="co">#&gt;        0     10       8</span></span>
<span><span class="co">#&gt;        0     16      10</span></span>
<span><span class="co">#&gt;        0     18      16</span></span>
<span><span class="co">#&gt;        0     19      18</span></span>
<span><span class="co">#&gt;        0     20      19</span></span>
<span><span class="co">#&gt;        0     22      20</span></span>
<span><span class="co">#&gt;        0     23      22</span></span>
<span><span class="co">#&gt;        0     25      23</span></span>
<span><span class="co">#&gt;        0     26      25</span></span>
<span><span class="co">#&gt;        0     27      26</span></span>
<span><span class="co">#&gt;        0     28      27</span></span>
<span><span class="co">#&gt;        0     29      28</span></span>
<span><span class="co">#&gt;        0     30      29</span></span>
<span><span class="co">#&gt;        0     33      30</span></span>
<span><span class="co">#&gt;        0     34      33</span></span>
<span><span class="co">#&gt;        0     36      34</span></span>
<span><span class="co">#&gt;        0     37      36</span></span>
<span><span class="co">#&gt;        0     38      37</span></span>
<span><span class="co">#&gt;        0     39      38</span></span>
<span><span class="co">#&gt;        0     40      39</span></span>
<span><span class="co">#&gt;        0     41      40</span></span>
<span><span class="co">#&gt;        0     42      41</span></span>
<span><span class="co">#&gt;        0     43      42</span></span>
<span><span class="co">#&gt;        0     45      43</span></span>
<span><span class="co">#&gt;        0     46      45</span></span>
<span><span class="co">#&gt;        0     48      46</span></span>
<span><span class="co">#&gt;        0     50      48</span></span>
<span><span class="co">#&gt;        0     51      50</span></span>
<span><span class="co">#&gt;        0     57      51</span></span>
<span><span class="co">#&gt;        0     58      57</span></span>
<span><span class="co">#&gt;        0     60      58</span></span>
<span><span class="co">#&gt;        0     67      60</span></span>
<span><span class="co">#&gt;        0     76      67</span></span>
<span><span class="co">#&gt;        0     79      76</span></span>
<span><span class="co">#&gt;        0     83      79</span></span>
<span><span class="co">#&gt;        0     84      83</span></span>
<span><span class="co">#&gt;        0     88      84</span></span>
<span><span class="co">#&gt;        0     89      88</span></span>
<span><span class="co">#&gt;        0     90      89</span></span>
<span><span class="co">#&gt;        0     95      90</span></span>
<span><span class="co">#&gt;        0     97      95</span></span>
<span><span class="co">#&gt;        0    102      97</span></span>
<span><span class="co">#&gt;        0    104     102</span></span>
<span><span class="co">#&gt;        0    106     104</span></span>
<span><span class="co">#&gt;        1    109     106</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generate-weights">Generate weights<a class="anchor" aria-label="anchor" href="#generate-weights"></a>
</h2>
<p>Now we simply need to generate the weights. The
<code>survivalCCW</code> function <code><a href="../reference/generate_ccw.html">generate_ccw()</a></code> will do
this for us.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clones_long_weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_ccw.html">generate_ccw</a></span><span class="op">(</span><span class="va">clones_long</span>, predvars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"sex"</span>, <span class="st">"perf"</span>, <span class="st">"stage"</span>, <span class="st">"deprivation"</span>, <span class="st">"charlson"</span>, <span class="st">"emergency"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">clones_long_weights</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;   time_id t_start    id surgery timetosurgery death sex charlson perf stage</span></span>
<span><span class="co">#&gt; 1       0       0 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt; 2       1       1 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt; 3       2       7 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt; 4       3       8 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt; 5       4      10 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt; 6       5      16 P1074       0            NA     1   2        1    2     1</span></span>
<span><span class="co">#&gt;   emergency fup_obs      age deprivation censor fup_censor clone fup_outcome</span></span>
<span><span class="co">#&gt; 1         0     345 76.67899        0.33      0     182.62     0           1</span></span>
<span><span class="co">#&gt; 2         0     345 76.67899        0.33      0     182.62     0           7</span></span>
<span><span class="co">#&gt; 3         0     345 76.67899        0.33      0     182.62     0           8</span></span>
<span><span class="co">#&gt; 4         0     345 76.67899        0.33      0     182.62     0          10</span></span>
<span><span class="co">#&gt; 5         0     345 76.67899        0.33      0     182.62     0          16</span></span>
<span><span class="co">#&gt; 6         0     345 76.67899        0.33      0     182.62     0          18</span></span>
<span><span class="co">#&gt;   outcome t_stop t_event        lp  t   hazard  p_uncens weight_cox</span></span>
<span><span class="co">#&gt; 1       0      1      NA -7.420857 NA   0.0000 1.0000000   1.000000</span></span>
<span><span class="co">#&gt; 2       0      7       1 -7.420857  1 162.5508 0.9072759   1.102201</span></span>
<span><span class="co">#&gt; 3       0      8       7 -7.420857  7 162.5508 0.9072759   1.102201</span></span>
<span><span class="co">#&gt; 4       0     10       8 -7.420857  8 171.7593 0.9022882   1.108293</span></span>
<span><span class="co">#&gt; 5       0     16      10 -7.420857 10 176.4477 0.8997594   1.111408</span></span>
<span><span class="co">#&gt; 6       0     18      16 -7.420857 16 181.2410 0.8971813   1.114602</span></span></code></pre></div>
<p>Let’s pick out a single patient and look at their data:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">clones_long_weights</span><span class="op">[</span><span class="va">clones_long_weights</span><span class="op">$</span><span class="va">id</span> <span class="op">==</span> <span class="st">"P5913"</span>, <span class="op">]</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt;  time_id t_start    id surgery timetosurgery death sex charlson perf stage</span></span>
<span><span class="co">#&gt;        0       0 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        0       0 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        1       1 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        2       7 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        3       8 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        4      10 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        5      16 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        6      18 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        7      19 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        8      20 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;        9      22 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       10      23 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       11      25 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       12      26 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       13      27 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       14      28 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       15      29 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       16      30 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       17      33 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       18      34 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       19      36 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       20      37 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       21      38 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       22      39 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       23      40 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       24      41 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       25      42 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       26      43 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       27      45 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       28      46 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       29      48 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       30      50 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       31      51 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       32      57 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       33      58 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       34      60 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       35      67 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       36      76 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       37      79 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       38      83 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       39      84 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       40      88 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       41      89 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       42      90 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       43      95 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       44      97 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       45     102 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       46     104 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;       47     106 P5913       1             1     1   1        2    0     1</span></span>
<span><span class="co">#&gt;  emergency fup_obs      age deprivation censor fup_censor clone fup_outcome</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      1          1     0           1</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1           1</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1           7</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1           8</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          10</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          16</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          18</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          19</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          20</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          22</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          23</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          25</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          26</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          27</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          28</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          29</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          30</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          33</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          34</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          36</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          37</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          38</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          39</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          40</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          41</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          42</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          43</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          45</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          46</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          48</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          50</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          51</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          57</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          58</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          60</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          67</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          76</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          79</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          83</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          84</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          88</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          89</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          90</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          95</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1          97</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1         102</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1         104</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1         106</span></span>
<span><span class="co">#&gt;          0     109 79.68515        0.37      0          1     1         109</span></span>
<span><span class="co">#&gt;  outcome t_stop t_event        lp   t hazard p_uncens weight_cox</span></span>
<span><span class="co">#&gt;        0      1      NA -5.592170  NA      0        1          1</span></span>
<span><span class="co">#&gt;        0      1      NA  5.653693  NA      0        1          1</span></span>
<span><span class="co">#&gt;        0      7       1  5.653693   1      0        1          1</span></span>
<span><span class="co">#&gt;        0      8       7  5.653693   7      0        1          1</span></span>
<span><span class="co">#&gt;        0     10       8  5.653693   8      0        1          1</span></span>
<span><span class="co">#&gt;        0     16      10  5.653693  10      0        1          1</span></span>
<span><span class="co">#&gt;        0     18      16  5.653693  16      0        1          1</span></span>
<span><span class="co">#&gt;        0     19      18  5.653693  18      0        1          1</span></span>
<span><span class="co">#&gt;        0     20      19  5.653693  19      0        1          1</span></span>
<span><span class="co">#&gt;        0     22      20  5.653693  20      0        1          1</span></span>
<span><span class="co">#&gt;        0     23      22  5.653693  22      0        1          1</span></span>
<span><span class="co">#&gt;        0     25      23  5.653693  23      0        1          1</span></span>
<span><span class="co">#&gt;        0     26      25  5.653693  25      0        1          1</span></span>
<span><span class="co">#&gt;        0     27      26  5.653693  26      0        1          1</span></span>
<span><span class="co">#&gt;        0     28      27  5.653693  27      0        1          1</span></span>
<span><span class="co">#&gt;        0     29      28  5.653693  28      0        1          1</span></span>
<span><span class="co">#&gt;        0     30      29  5.653693  29      0        1          1</span></span>
<span><span class="co">#&gt;        0     33      30  5.653693  30      0        1          1</span></span>
<span><span class="co">#&gt;        0     34      33  5.653693  33      0        1          1</span></span>
<span><span class="co">#&gt;        0     36      34  5.653693  34      0        1          1</span></span>
<span><span class="co">#&gt;        0     37      36  5.653693  36      0        1          1</span></span>
<span><span class="co">#&gt;        0     38      37  5.653693  37      0        1          1</span></span>
<span><span class="co">#&gt;        0     39      38  5.653693  38      0        1          1</span></span>
<span><span class="co">#&gt;        0     40      39  5.653693  39      0        1          1</span></span>
<span><span class="co">#&gt;        0     41      40  5.653693  40      0        1          1</span></span>
<span><span class="co">#&gt;        0     42      41  5.653693  41      0        1          1</span></span>
<span><span class="co">#&gt;        0     43      42  5.653693  42      0        1          1</span></span>
<span><span class="co">#&gt;        0     45      43  5.653693  43      0        1          1</span></span>
<span><span class="co">#&gt;        0     46      45  5.653693  45      0        1          1</span></span>
<span><span class="co">#&gt;        0     48      46  5.653693  46      0        1          1</span></span>
<span><span class="co">#&gt;        0     50      48  5.653693  48      0        1          1</span></span>
<span><span class="co">#&gt;        0     51      50  5.653693  50      0        1          1</span></span>
<span><span class="co">#&gt;        0     57      51  5.653693  51      0        1          1</span></span>
<span><span class="co">#&gt;        0     58      57  5.653693  57      0        1          1</span></span>
<span><span class="co">#&gt;        0     60      58  5.653693  58      0        1          1</span></span>
<span><span class="co">#&gt;        0     67      60  5.653693  60      0        1          1</span></span>
<span><span class="co">#&gt;        0     76      67  5.653693  67      0        1          1</span></span>
<span><span class="co">#&gt;        0     79      76  5.653693  76      0        1          1</span></span>
<span><span class="co">#&gt;        0     83      79  5.653693  79      0        1          1</span></span>
<span><span class="co">#&gt;        0     84      83  5.653693  83      0        1          1</span></span>
<span><span class="co">#&gt;        0     88      84  5.653693  84      0        1          1</span></span>
<span><span class="co">#&gt;        0     89      88  5.653693  88      0        1          1</span></span>
<span><span class="co">#&gt;        0     90      89  5.653693  89      0        1          1</span></span>
<span><span class="co">#&gt;        0     95      90  5.653693  90      0        1          1</span></span>
<span><span class="co">#&gt;        0     97      95  5.653693  95      0        1          1</span></span>
<span><span class="co">#&gt;        0    102      97  5.653693  97      0        1          1</span></span>
<span><span class="co">#&gt;        0    104     102  5.653693 102      0        1          1</span></span>
<span><span class="co">#&gt;        0    106     104  5.653693 104      0        1          1</span></span>
<span><span class="co">#&gt;        1    109     106  5.653693 106      0        1          1</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="evaluate-outcomes">Evaluate outcomes<a class="anchor" aria-label="anchor" href="#evaluate-outcomes"></a>
</h2>
<p>We now have everything we need to conduct a CCW analysis. For
instance, we can pipe things together to evaluate the hazard ratio for
surgery vs no surgery:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="va">toy_df</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/create_clones.html">create_clones</a></span><span class="op">(</span></span>
<span>    id <span class="op">=</span> <span class="st">'id'</span>,</span>
<span>    event <span class="op">=</span> <span class="st">'death'</span>,</span>
<span>    time_to_event <span class="op">=</span> <span class="st">'fup_obs'</span>,</span>
<span>    exposure <span class="op">=</span> <span class="st">'surgery'</span>,</span>
<span>    time_to_exposure <span class="op">=</span> <span class="st">'timetosurgery'</span>,</span>
<span>    ced_window <span class="op">=</span> <span class="fl">365.25</span><span class="op">/</span><span class="fl">2</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/cast_clones_to_long.html">cast_clones_to_long</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/generate_ccw.html">generate_ccw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'age'</span>, <span class="st">'sex'</span>, <span class="st">'perf'</span>, <span class="st">'stage'</span>, <span class="st">'deprivation'</span>, <span class="st">'charlson'</span>, <span class="st">'emergency'</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">t_start</span>, <span class="va">t_stop</span>, <span class="va">outcome</span><span class="op">)</span> <span class="op">~</span> <span class="va">clone</span>, data <span class="op">=</span> <span class="va">df</span>, weights <span class="op">=</span> <span class="va">weight_cox</span><span class="op">)</span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; coxph(formula = Surv(t_start, t_stop, outcome) ~ clone, data = df, </span></span>
<span><span class="co">#&gt;     weights = weight_cox)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;          coef exp(coef) se(coef) robust se      z      p</span></span>
<span><span class="co">#&gt; clone -0.4988    0.6073   0.2153    0.2794 -1.785 0.0742</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Likelihood ratio test=5.51  on 1 df, p=0.01894</span></span>
<span><span class="co">#&gt; n= 22772, number of events= 62</span></span></code></pre></div>
<p>Note that we used <code>outcome</code> and not <code>death</code> in
the <code><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph()</a></code> model. Still, there is of course a problem with
this analysis, as the cloning process renders the variance invalid. The
simplest approach to addressing this is to bootstrap the variance. I
have not made a function to do this yet, but leave the below as an
example of how to do this.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">boot</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'boot'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:survival':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     aml</span></span>
<span></span>
<span><span class="va">boot_cox</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">indices</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co"># Make long data.frame with weights</span></span>
<span>  <span class="va">ccw_df</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">indices</span>, <span class="op">]</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/create_clones.html">create_clones</a></span><span class="op">(</span></span>
<span>      id <span class="op">=</span> <span class="st">'id'</span>,</span>
<span>      event <span class="op">=</span> <span class="st">'death'</span>,</span>
<span>      time_to_event <span class="op">=</span> <span class="st">'fup_obs'</span>,</span>
<span>      exposure <span class="op">=</span> <span class="st">'surgery'</span>,</span>
<span>      time_to_exposure <span class="op">=</span> <span class="st">'timetosurgery'</span>,</span>
<span>      ced_window <span class="op">=</span> <span class="fl">182.62</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/cast_clones_to_long.html">cast_clones_to_long</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../reference/generate_ccw.html">generate_ccw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'age'</span>, <span class="st">'sex'</span>, <span class="st">'perf'</span>, <span class="st">'stage'</span>, <span class="st">'deprivation'</span>, <span class="st">'charlson'</span>, <span class="st">'emergency'</span><span class="op">)</span><span class="op">)</span></span>
<span>    </span>
<span></span>
<span>  <span class="co"># Extract HR from CoxPH</span></span>
<span>  <span class="va">cox_ccw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">t_start</span>, <span class="va">t_stop</span>, <span class="va">outcome</span><span class="op">)</span> <span class="op">~</span> <span class="va">clone</span>, data <span class="op">=</span> <span class="va">ccw_df</span>, weights <span class="op">=</span> <span class="va">weight_cox</span><span class="op">)</span> </span>
<span>   </span>
<span>  <span class="va">hr</span> <span class="op">&lt;-</span> <span class="va">cox_ccw</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"hr"</span> <span class="op">=</span> <span class="va">hr</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Create survfit objects for each of treated and untreated</span></span>
<span>  <span class="va">surv_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">t_start</span>, <span class="va">t_stop</span>, <span class="va">outcome</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1L</span>, data <span class="op">=</span> <span class="va">ccw_df</span><span class="op">[</span><span class="va">ccw_df</span><span class="op">$</span><span class="va">clone</span> <span class="op">==</span> <span class="fl">1</span>, <span class="op">]</span>, weights <span class="op">=</span> <span class="va">weight_cox</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">surv_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">t_start</span>, <span class="va">t_stop</span>, <span class="va">outcome</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1L</span>, data <span class="op">=</span> <span class="va">ccw_df</span><span class="op">[</span><span class="va">ccw_df</span><span class="op">$</span><span class="va">clone</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span>, weights <span class="op">=</span> <span class="va">weight_cox</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># RMST difference</span></span>
<span>  <span class="va">rmst_1</span> <span class="op">&lt;-</span> <span class="va">surv_1</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span>rmean <span class="op">=</span> <span class="fl">365</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="op">(</span>\<span class="op">(</span><span class="va">summary</span><span class="op">)</span> <span class="va">summary</span><span class="op">$</span><span class="va">table</span><span class="op">)</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="op">(</span>\<span class="op">(</span><span class="va">table</span><span class="op">)</span> <span class="va">table</span><span class="op">[</span><span class="st">"rmean"</span><span class="op">]</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">rmst_0</span> <span class="op">&lt;-</span> <span class="va">surv_0</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span>rmean <span class="op">=</span> <span class="fl">365</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="op">(</span>\<span class="op">(</span><span class="va">summary</span><span class="op">)</span> <span class="va">summary</span><span class="op">$</span><span class="va">table</span><span class="op">)</span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="op">(</span>\<span class="op">(</span><span class="va">table</span><span class="op">)</span> <span class="va">table</span><span class="op">[</span><span class="st">"rmean"</span><span class="op">]</span><span class="op">)</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">rmst_diff</span> <span class="op">&lt;-</span> <span class="va">rmst_1</span> <span class="op">-</span> <span class="va">rmst_0</span></span>
<span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">out</span>, <span class="st">"rmst_diff"</span> <span class="op">=</span> <span class="va">rmst_diff</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># 1-year survival difference</span></span>
<span>  <span class="co"># Find the index of the time point closest to 1 year</span></span>
<span>  <span class="va">index_1yr_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">surv_1</span><span class="op">$</span><span class="va">time</span> <span class="op">-</span> <span class="fl">365</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">index_1yr_0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">surv_0</span><span class="op">$</span><span class="va">time</span> <span class="op">-</span> <span class="fl">365</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Get the 1-year survival probabilities</span></span>
<span>  <span class="va">surv_1_1yr</span> <span class="op">&lt;-</span> <span class="va">surv_1</span><span class="op">$</span><span class="va">surv</span><span class="op">[</span><span class="va">index_1yr_1</span><span class="op">]</span></span>
<span>  <span class="va">surv_0_1yr</span> <span class="op">&lt;-</span> <span class="va">surv_0</span><span class="op">$</span><span class="va">surv</span><span class="op">[</span><span class="va">index_1yr_0</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">surv_diff_1yr</span> <span class="op">&lt;-</span> <span class="va">surv_1_1yr</span> <span class="op">-</span> <span class="va">surv_0_1yr</span></span>
<span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">out</span>, <span class="st">"surv_diff_1yr"</span> <span class="op">=</span> <span class="va">surv_diff_1yr</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">boot_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">toy_df</span>, statistic <span class="op">=</span> <span class="va">boot_cox</span>, R <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="hazard-ratios">Hazard ratios<a class="anchor" aria-label="anchor" href="#hazard-ratios"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci</a></span><span class="op">(</span><span class="va">boot_out</span>, type <span class="op">=</span> <span class="st">"norm"</span>, index <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS</span></span>
<span><span class="co">#&gt; Based on 10 bootstrap replicates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CALL : </span></span>
<span><span class="co">#&gt; boot.ci(boot.out = boot_out, type = "norm", index = 1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Intervals : </span></span>
<span><span class="co">#&gt; Level      Normal        </span></span>
<span><span class="co">#&gt; 95%   ( 0.3370,  0.7308 )  </span></span>
<span><span class="co">#&gt; Calculations and Intervals on Original Scale</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="rmst">RMST<a class="anchor" aria-label="anchor" href="#rmst"></a>
</h3>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci</a></span><span class="op">(</span><span class="va">boot_out</span>, type <span class="op">=</span> <span class="st">"norm"</span>, index <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS</span></span>
<span><span class="co">#&gt; Based on 10 bootstrap replicates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CALL : </span></span>
<span><span class="co">#&gt; boot.ci(boot.out = boot_out, type = "norm", index = 2)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Intervals : </span></span>
<span><span class="co">#&gt; Level      Normal        </span></span>
<span><span class="co">#&gt; 95%   ( 0.236, 15.156 )  </span></span>
<span><span class="co">#&gt; Calculations and Intervals on Original Scale</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="year-survival">1-year survival<a class="anchor" aria-label="anchor" href="#year-survival"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci</a></span><span class="op">(</span><span class="va">boot_out</span>, type <span class="op">=</span> <span class="st">"norm"</span>, index <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt; BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS</span></span>
<span><span class="co">#&gt; Based on 10 bootstrap replicates</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; CALL : </span></span>
<span><span class="co">#&gt; boot.ci(boot.out = boot_out, type = "norm", index = 3)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Intervals : </span></span>
<span><span class="co">#&gt; Level      Normal        </span></span>
<span><span class="co">#&gt; 95%   ( 0.0618,  0.2195 )  </span></span>
<span><span class="co">#&gt; Calculations and Intervals on Original Scale</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Matthew Secrest.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
